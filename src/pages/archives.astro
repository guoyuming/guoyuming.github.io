---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Helper to convert slug to title
function slugToTitle(slug: string): string {
  return slug
    .replace(/^\d{6}-/, '') // Remove date prefix like "170130-"
    .replace(/-/g, ' ')     // Replace hyphens with spaces
    .trim();
}

const posts = await getCollection('posts');

// Add derived titles and sort
const sortedPosts = posts
  .map(post => ({
    ...post,
    displayTitle: post.data.title || slugToTitle(post.slug)
  }))
  .sort((a, b) => a.displayTitle.localeCompare(b.displayTitle, 'zh-CN'));

// Extract preview text from markdown body
const getExcerpt = (body: string, maxLength = 200) => {
  const plainText = body
    .replace(/^---[\s\S]*?---/, '') // Remove frontmatter
    .replace(/!\[.*?\]\(.*?\)/g, '') // Remove images
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to text
    .replace(/[#*_`>\[\]]/g, '') // Remove markdown symbols
    .replace(/\n+/g, ' ') // Replace newlines with spaces
    .trim();
  
  if (plainText.length <= maxLength) return plainText;
  return plainText.substring(0, maxLength).trim() + '...';
};

---

<BaseLayout title="博客">
  <div class="archive-split-container">
    <!-- Left Panel: Article List -->
    <aside class="article-list-panel">
      <div class="panel-header">
        <h1 class="page-title">博客</h1>
        <p class="article-count">{posts.length} 篇文章</p>
      </div>
      
      <nav class="article-list" role="listbox" aria-label="文章列表">
        {sortedPosts.map((post, index) => (
          <button 
            class={`article-item ${index === 0 ? 'is-active' : ''}`}
            data-index={index}
            data-slug={post.slug}
            data-title={post.displayTitle}
            data-excerpt={getExcerpt(post.body)}
            role="option"
            aria-selected={index === 0 ? 'true' : 'false'}
          >
            <span class="article-item-indicator"></span>
            <span class="article-item-title">{post.displayTitle}</span>
          </button>
        ))}
      </nav>
    </aside>

    <!-- Right Panel: Preview Card -->
    <section class="preview-panel">
      <a 
        href={`/posts/${sortedPosts[0]?.slug}`} 
        class="preview-card" 
        id="preview-card"
      >
        <article class="preview-card-inner">
          <div class="preview-content">
            <h2 class="preview-title" id="preview-title">
              {sortedPosts[0]?.displayTitle}
            </h2>
            <p class="preview-excerpt" id="preview-excerpt">
              {getExcerpt(sortedPosts[0]?.body || '')}
            </p>
          </div>
        </article>
      </a>
    </section>
  </div>

</BaseLayout>

<style>
  .archive-split-container {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 3rem;
    min-height: calc(100vh - var(--nav-height) - 200px);
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Left Panel Styles */
  .article-list-panel {
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - var(--nav-height) - 120px);
    position: sticky;
    top: calc(var(--nav-height) + 60px);
  }

  .panel-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .page-title {
    font-family: var(--font-display);
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 0.25rem;
  }

  .article-count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .article-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.5rem;
    margin-right: -0.5rem;
    
    /* Custom scrollbar */
    scrollbar-width: thin;
    scrollbar-color: rgba(235, 229, 222, 0.2) transparent;
  }

  .article-list::-webkit-scrollbar {
    width: 6px;
  }

  .article-list::-webkit-scrollbar-track {
    background: transparent;
  }

  .article-list::-webkit-scrollbar-thumb {
    background: rgba(235, 229, 222, 0.2);
    border-radius: 3px;
  }

  .article-list::-webkit-scrollbar-thumb:hover {
    background: rgba(235, 229, 222, 0.35);
  }

  /* Article Item Styles */
  .article-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.875rem 1rem;
    margin-bottom: 0.25rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    text-align: left;
    font-family: var(--font-heading);
    font-size: 0.9375rem;
    color: var(--color-text);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .article-item-indicator {
    width: 3px;
    height: 0;
    background: var(--color-accent);
    border-radius: 2px;
    transition: height 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
  }

  .article-item-title {
    flex: 1;
    line-height: 1.4;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .article-item:hover {
    background: var(--color-bg-alt);
  }

  .article-item:hover .article-item-indicator {
    height: 1.25rem;
  }

  .article-item:hover .article-item-title {
    transform: translateX(4px);
  }

  .article-item.is-active {
    background: var(--color-bg-alt);
    color: var(--color-accent);
  }

  .article-item.is-active .article-item-indicator {
    height: 100%;
  }

  .article-item:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--color-accent);
  }

  .article-item:focus:not(:focus-visible) {
    box-shadow: none;
  }

  /* Right Panel Styles */
  .preview-panel {
    display: flex;
    align-items: flex-start;
    padding-top: 3rem;
  }

  .preview-card {
    display: block;
    position: sticky;
    top: calc(var(--nav-height) + 60px);
    width: 100%;
    max-width: 480px;
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-card);
    overflow: hidden;
    animation: cardEnter 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .preview-card:hover {
    border-color: var(--color-accent);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  @keyframes cardEnter {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .preview-card-inner {
    padding: 2rem;
  }

  .preview-content {
    min-height: 180px;
  }

  .preview-title {
    font-family: var(--font-heading);
    font-size: 1.375rem;
    font-weight: 700;
    line-height: 1.35;
    margin-bottom: 1rem;
    color: var(--color-text);
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.15s ease-out, transform 0.2s ease-out;
  }

  .preview-title.is-transitioning {
    opacity: 0;
    transform: translateY(-8px);
  }

  .preview-excerpt {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--color-text-muted);
    margin-bottom: 0;
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.15s ease-out 0.05s, transform 0.2s ease-out 0.05s;
  }

  .preview-excerpt.is-transitioning {
    opacity: 0;
    transform: translateY(-8px);
  }

  /* Responsive Styles */
  @media (max-width: 900px) {
    .archive-split-container {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .article-list-panel {
      position: relative;
      top: 0;
      max-height: none;
    }

    .article-list {
      max-height: 50vh;
    }

    .preview-panel {
      padding-top: 0;
    }

    .preview-card {
      position: relative;
      top: 0;
      max-width: 100%;
    }
  }

  @media (max-width: 480px) {
    .page-title {
      font-size: 1.5rem;
    }

    .article-item {
      padding: 0.75rem;
      font-size: 0.875rem;
    }

    .preview-card-inner {
      padding: 1.5rem;
    }

    .preview-title {
      font-size: 1.125rem;
    }

    .preview-content {
      min-height: 140px;
    }
  }
</style>

<script is:inline>
  (function() {
    // Get DOM elements
    var articleItems = document.querySelectorAll('.article-item');
    var previewTitle = document.getElementById('preview-title');
    var previewExcerpt = document.getElementById('preview-excerpt');
    var previewCard = document.getElementById('preview-card');
    
    if (!previewTitle || !previewExcerpt || !previewCard || articleItems.length === 0) return;
    
    var currentItem = articleItems[0];
    
    // Update preview card with data from the clicked item
    function updatePreview(item) {
      var title = item.dataset.title;
      var excerpt = item.dataset.excerpt;
      var slug = item.dataset.slug;
      
      previewTitle.textContent = title;
      previewExcerpt.textContent = excerpt;
      previewCard.href = '/posts/' + slug;
    }
    
    // Set active state on article item
    function setActiveItem(activeItem) {
      articleItems.forEach(function(item) {
        item.classList.remove('is-active');
        item.setAttribute('aria-selected', 'false');
      });
      activeItem.classList.add('is-active');
      activeItem.setAttribute('aria-selected', 'true');
      currentItem = activeItem;
    }
    
    // Attach event listeners to each item
    articleItems.forEach(function(item) {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        setActiveItem(item);
        updatePreview(item);
      });
      
      item.addEventListener('mouseenter', function() {
        setActiveItem(item);
        updatePreview(item);
      });
    });
    
    // Keyboard navigation
    var articleList = document.querySelector('.article-list');
    if (articleList) {
      articleList.addEventListener('keydown', function(e) {
        var currentIndex = Array.prototype.indexOf.call(articleItems, currentItem);
        var newIndex = currentIndex;
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          newIndex = Math.min(currentIndex + 1, articleItems.length - 1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          newIndex = Math.max(currentIndex - 1, 0);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          window.location.href = previewCard.href;
          return;
        }
        
        if (newIndex !== currentIndex) {
          var newItem = articleItems[newIndex];
          setActiveItem(newItem);
          updatePreview(newItem);
          newItem.focus();
          newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }
  })();
</script>

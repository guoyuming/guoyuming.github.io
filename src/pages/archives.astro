---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('posts');
const sortedPosts = posts.sort((a, b) => 
  a.data.title.localeCompare(b.data.title, 'zh-CN')
);

// Extract preview text from markdown body
const getExcerpt = (body: string, maxLength = 200) => {
  const plainText = body
    .replace(/^---[\s\S]*?---/, '') // Remove frontmatter
    .replace(/!\[.*?\]\(.*?\)/g, '') // Remove images
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to text
    .replace(/[#*_`>\[\]]/g, '') // Remove markdown symbols
    .replace(/\n+/g, ' ') // Replace newlines with spaces
    .trim();
  
  if (plainText.length <= maxLength) return plainText;
  return plainText.substring(0, maxLength).trim() + '...';
};

// Prepare posts data for client-side
const postsData = sortedPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  excerpt: getExcerpt(post.body),
}));
---

<BaseLayout title="博客">
  <div class="archive-split-container">
    <!-- Left Panel: Article List -->
    <aside class="article-list-panel">
      <div class="panel-header">
        <h1 class="page-title">博客</h1>
        <p class="article-count">{posts.length} 篇文章</p>
      </div>
      
      <nav class="article-list" role="listbox" aria-label="文章列表">
        {sortedPosts.map((post, index) => (
          <button 
            class={`article-item ${index === 0 ? 'is-active' : ''}`}
            data-index={index}
            data-slug={post.slug}
            role="option"
            aria-selected={index === 0 ? 'true' : 'false'}
          >
            <span class="article-item-indicator"></span>
            <span class="article-item-title">{post.data.title}</span>
          </button>
        ))}
      </nav>
    </aside>

    <!-- Right Panel: Preview Card -->
    <section class="preview-panel">
      <a 
        href={`/posts/${sortedPosts[0]?.slug}`} 
        class="preview-card" 
        id="preview-card"
      >
        <article class="preview-card-inner">
          <div class="preview-content">
            <h2 class="preview-title" id="preview-title">
              {sortedPosts[0]?.data.title}
            </h2>
            <p class="preview-excerpt" id="preview-excerpt">
              {getExcerpt(sortedPosts[0]?.body || '')}
            </p>
          </div>
        </article>
      </a>
    </section>
  </div>

  <!-- Pass posts data to client -->
  <script type="application/json" id="posts-data">
    {JSON.stringify(postsData)}
  </script>
</BaseLayout>

<style>
  .archive-split-container {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 3rem;
    min-height: calc(100vh - var(--nav-height) - 200px);
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Left Panel Styles */
  .article-list-panel {
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - var(--nav-height) - 120px);
    position: sticky;
    top: calc(var(--nav-height) + 60px);
  }

  .panel-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .page-title {
    font-family: var(--font-display);
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 0.25rem;
  }

  .article-count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .article-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.5rem;
    margin-right: -0.5rem;
    
    /* Custom scrollbar */
    scrollbar-width: thin;
    scrollbar-color: rgba(235, 229, 222, 0.2) transparent;
  }

  .article-list::-webkit-scrollbar {
    width: 6px;
  }

  .article-list::-webkit-scrollbar-track {
    background: transparent;
  }

  .article-list::-webkit-scrollbar-thumb {
    background: rgba(235, 229, 222, 0.2);
    border-radius: 3px;
  }

  .article-list::-webkit-scrollbar-thumb:hover {
    background: rgba(235, 229, 222, 0.35);
  }

  /* Article Item Styles */
  .article-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.875rem 1rem;
    margin-bottom: 0.25rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    text-align: left;
    font-family: var(--font-heading);
    font-size: 0.9375rem;
    color: var(--color-text);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .article-item-indicator {
    width: 3px;
    height: 0;
    background: var(--color-accent);
    border-radius: 2px;
    transition: height 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
  }

  .article-item-title {
    flex: 1;
    line-height: 1.4;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .article-item:hover {
    background: var(--color-bg-alt);
  }

  .article-item:hover .article-item-indicator {
    height: 1.25rem;
  }

  .article-item:hover .article-item-title {
    transform: translateX(4px);
  }

  .article-item.is-active {
    background: var(--color-bg-alt);
    color: var(--color-accent);
  }

  .article-item.is-active .article-item-indicator {
    height: 100%;
  }

  .article-item:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--color-accent);
  }

  .article-item:focus:not(:focus-visible) {
    box-shadow: none;
  }

  /* Right Panel Styles */
  .preview-panel {
    display: flex;
    align-items: flex-start;
    padding-top: 3rem;
  }

  .preview-card {
    display: block;
    position: sticky;
    top: calc(var(--nav-height) + 60px);
    width: 100%;
    max-width: 480px;
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-card);
    overflow: hidden;
    animation: cardEnter 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .preview-card:hover {
    border-color: var(--color-accent);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  @keyframes cardEnter {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .preview-card-inner {
    padding: 2rem;
  }

  .preview-content {
    min-height: 180px;
  }

  .preview-title {
    font-family: var(--font-heading);
    font-size: 1.375rem;
    font-weight: 700;
    line-height: 1.35;
    margin-bottom: 1rem;
    color: var(--color-text);
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.15s ease-out, transform 0.2s ease-out;
  }

  .preview-title.is-transitioning {
    opacity: 0;
    transform: translateY(-8px);
  }

  .preview-excerpt {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--color-text-muted);
    margin-bottom: 0;
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.15s ease-out 0.05s, transform 0.2s ease-out 0.05s;
  }

  .preview-excerpt.is-transitioning {
    opacity: 0;
    transform: translateY(-8px);
  }

  /* Responsive Styles */
  @media (max-width: 900px) {
    .archive-split-container {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .article-list-panel {
      position: relative;
      top: 0;
      max-height: none;
    }

    .article-list {
      max-height: 50vh;
    }

    .preview-panel {
      padding-top: 0;
    }

    .preview-card {
      position: relative;
      top: 0;
      max-width: 100%;
    }
  }

  @media (max-width: 480px) {
    .page-title {
      font-size: 1.5rem;
    }

    .article-item {
      padding: 0.75rem;
      font-size: 0.875rem;
    }

    .preview-card-inner {
      padding: 1.5rem;
    }

    .preview-title {
      font-size: 1.125rem;
    }

    .preview-content {
      min-height: 140px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Get posts data
    const postsDataEl = document.getElementById('posts-data');
    if (!postsDataEl) return;
    
    const posts: Array<{ slug: string; title: string; excerpt: string }> = JSON.parse(postsDataEl.textContent || '[]');
    
    // Get DOM elements
    const articleItems = document.querySelectorAll('.article-item');
    const previewTitle = document.getElementById('preview-title');
    const previewExcerpt = document.getElementById('preview-excerpt');
    const previewCard = document.getElementById('preview-card') as HTMLAnchorElement;
    
    if (!previewTitle || !previewExcerpt || !previewCard) return;
    
    let currentIndex = 0;
    let transitionTimeout: ReturnType<typeof setTimeout> | null = null;
    let hoverTimeout: ReturnType<typeof setTimeout> | null = null;
    
    // Update preview card with animation
    const updatePreview = (index: number, force = false) => {
      if (index >= posts.length) return;
      if (!force && index === currentIndex) return;
      
      // Cancel any pending transition
      if (transitionTimeout) {
        clearTimeout(transitionTimeout);
        transitionTimeout = null;
      }
      
      // Add transitioning class for fade out
      previewTitle.classList.add('is-transitioning');
      previewExcerpt.classList.add('is-transitioning');
      
      // Update content after fade out
      transitionTimeout = setTimeout(() => {
        const post = posts[index];
        previewTitle.textContent = post.title;
        previewExcerpt.textContent = post.excerpt;
        previewCard.href = `/posts/${post.slug}`;
        
        // Remove transitioning class for fade in
        previewTitle.classList.remove('is-transitioning');
        previewExcerpt.classList.remove('is-transitioning');
        
        currentIndex = index;
        transitionTimeout = null;
      }, 150);
    };
    
    // Set active state on article item
    const setActiveItem = (index: number) => {
      articleItems.forEach((item, i) => {
        const isActive = i === index;
        item.classList.toggle('is-active', isActive);
        item.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
    };
    
    // Handle hover with debounce
    const handleHover = (index: number) => {
      if (hoverTimeout) clearTimeout(hoverTimeout);
      hoverTimeout = setTimeout(() => {
        setActiveItem(index);
        updatePreview(index);
      }, 50);
    };
    
    // Handle click - force update even if same index
    const handleClick = (index: number) => {
      if (hoverTimeout) clearTimeout(hoverTimeout);
      setActiveItem(index);
      updatePreview(index, true);
    };
    
    // Attach event listeners
    articleItems.forEach((item, index) => {
      item.addEventListener('mouseenter', () => handleHover(index));
      item.addEventListener('click', () => handleClick(index));
      item.addEventListener('focus', () => handleHover(index));
    });
    
    // Keyboard navigation
    const articleList = document.querySelector('.article-list');
    if (articleList) {
      articleList.addEventListener('keydown', (e: Event) => {
        const keyEvent = e as KeyboardEvent;
        let newIndex = currentIndex;
        
        if (keyEvent.key === 'ArrowDown') {
          e.preventDefault();
          newIndex = Math.min(currentIndex + 1, posts.length - 1);
        } else if (keyEvent.key === 'ArrowUp') {
          e.preventDefault();
          newIndex = Math.max(currentIndex - 1, 0);
        } else if (keyEvent.key === 'Enter') {
          e.preventDefault();
          previewCard.click();
          return;
        }
        
        if (newIndex !== currentIndex) {
          setActiveItem(newIndex);
          updatePreview(newIndex);
          (articleItems[newIndex] as HTMLElement).focus();
          
          // Scroll into view if needed
          (articleItems[newIndex] as HTMLElement).scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
          });
        }
      });
    }
  });
</script>

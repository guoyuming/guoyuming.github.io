---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Helper to convert slug to title
function slugToTitle(slug: string): string {
  return slug
    .replace(/^\d{6}-/, '') // Remove date prefix like "170130-"
    .replace(/-/g, ' ')     // Replace hyphens with spaces
    .trim();
}

const posts = await getCollection('posts');

// Add derived titles and sort
const sortedPosts = posts
  .map(post => ({
    ...post,
    displayTitle: post.data.title || slugToTitle(post.slug)
  }))
  .sort((a, b) => a.displayTitle.localeCompare(b.displayTitle, 'zh-CN'));

// Get first ~80 characters of content for excerpt (simplified approach)
const getExcerpt = (body: string, maxLength = 100) => {
  // Remove markdown formatting and get plain text
  const plainText = body
    .replace(/^---[\s\S]*?---/, '') // Remove frontmatter
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to text
    .replace(/[#*_`>\[\]]/g, '') // Remove markdown symbols
    .replace(/\n+/g, ' ') // Replace newlines with spaces
    .trim();
  
  if (plainText.length <= maxLength) return plainText;
  return plainText.substring(0, maxLength).trim() + '...';
};
---

<BaseLayout title="首页">
  <ul class="post-grid">
    {sortedPosts.map((post, index) => (
      <li class="post-card">
        <a href={`/posts/${post.slug}`} class="post-card-link">
          <div class="post-card-content">
            <h2 class="post-card-title">{post.displayTitle}</h2>
            <p class="post-card-excerpt">{getExcerpt(post.body)}</p>
          </div>
        </a>
      </li>
    ))}
  </ul>
</BaseLayout>
